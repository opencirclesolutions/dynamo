<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BaseDaoImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Implementation</a> &gt; <a href="index.source.html" class="el_package">org.dynamoframework.dao.impl</a> &gt; <span class="el_source">BaseDaoImpl.java</span></div><h1>BaseDaoImpl.java</h1><pre class="source lang-java linenums">package org.dynamoframework.dao.impl;

/*-
 * #%L
 * Dynamo Framework
 * %%
 * Copyright (C) 2014 - 2024 Open Circle Solutions
 * %%
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * #L%
 */

import com.querydsl.core.types.dsl.EntityPathBase;
import com.querydsl.jpa.impl.JPADeleteClause;
import com.querydsl.jpa.impl.JPAQuery;
import com.querydsl.jpa.impl.JPAUpdateClause;
import jakarta.persistence.*;
import jakarta.persistence.criteria.CriteriaQuery;
import org.dynamoframework.dao.*;
import org.dynamoframework.domain.AbstractEntity;
import org.dynamoframework.domain.model.EntityModelFactory;
import org.dynamoframework.exception.OCSRuntimeException;
import org.dynamoframework.filter.Filter;
import org.springframework.beans.factory.annotation.Autowired;

import java.util.*;
import java.util.stream.Collectors;

/**
 * Base class for all DAO implementations
 *
 * @param &lt;ID&gt; type parameter, the type of the primary key of the domain object
 * @param &lt;T&gt;  type parameter, the entity class
 * @author bas.rutten
 */
<span class="fc" id="L46">public abstract class BaseDaoImpl&lt;ID, T extends AbstractEntity&lt;ID&gt;&gt; implements BaseDao&lt;ID, T&gt; {</span>

	@PersistenceContext
	private EntityManager entityManager;

	@Autowired
	private EntityModelFactory entityModelFactory;

	/**
	 * Adds a parameter to a query but only if the provided value is not null
	 *
	 * @param query the query to add the parameter to
	 * @param name  the name of the parameter
	 * @param value the value of the parameter
	 */
	protected void addParameter(Query query, String name, Object value) {
<span class="nc bnc" id="L62" title="All 2 branches missed.">		if (value != null) {</span>
<span class="nc" id="L63">			query.setParameter(name, value);</span>
		}
<span class="nc" id="L65">	}</span>

	@Override
	@SuppressWarnings(&quot;deprecation&quot;)
	public long count() {
<span class="nc" id="L70">		return createQuery().fetchCount();</span>
	}

	@Override
	public long count(Filter filter, boolean distinct) {
<span class="fc" id="L75">		TypedQuery&lt;Long&gt; query = JpaQueryBuilder.createCountQuery(entityManager, getEntityClass(), filter, distinct);</span>
<span class="fc" id="L76">		return query.getSingleResult();</span>
	}

	/**
	 * Creates a new JPADeleteClause for the entity
	 *
	 * @return the newly created JPADeleteClause
	 */
	protected JPADeleteClause createDeleteClause() {
<span class="nc" id="L85">		return new JPADeleteClause(getEntityManager(), getDslRoot());</span>
	}

	/**
	 * Creates a default query that simply retrieves instances of the domain class
	 *
	 * @return the newly created JPAQuery
	 */
	protected JPAQuery&lt;T&gt; createQuery() {
<span class="fc" id="L94">		JPAQuery&lt;T&gt; query = new JPAQuery&lt;&gt;(entityManager);</span>
<span class="fc" id="L95">		query.from(getDslRoot());</span>
<span class="fc" id="L96">		return query;</span>
	}

	/**
	 * Creates a new JPAUpdateClause for the entity
	 *
	 * @return the newly created JPAUpdateClause
	 */
	protected JPAUpdateClause createUpdateClause() {
<span class="nc" id="L105">		return new JPAUpdateClause(getEntityManager(), getDslRoot());</span>
	}

	@Override
	public void delete(List&lt;T&gt; list) {
<span class="nc" id="L110">		list.forEach(this::delete);</span>
<span class="nc" id="L111">	}</span>

	@Override
	public void delete(T entity) {
<span class="fc" id="L115">		entity = entityManager.merge(entity);</span>
<span class="fc" id="L116">		entityManager.remove(entity);</span>
<span class="fc" id="L117">	}</span>

	@Override
	public void deleteAll() {
<span class="nc" id="L121">		this.delete(this.findAll());</span>
<span class="nc" id="L122">	}</span>

	@Override
	public List&lt;T&gt; fetch(Filter filter, FetchJoinInformation... joins) {
<span class="fc" id="L126">		return fetch(filter, null, null, joins);</span>
	}

	@Override
	public List&lt;T&gt; fetch(Filter filter, Pageable pageable, FetchJoinInformation... joins) {
<span class="pc bpc" id="L131" title="1 of 2 branches missed.">		return fetch(filter, pageable, pageable == null ? null : pageable.getSortOrders(), joins);</span>
	}

	/**
	 * Executes a fetch query - watch out, paging combined with one-to-many joins
	 * leads to everything being calculated in-memory
	 *
	 * @param filter     the filter to apply
	 * @param pageable   object containing the paging data
	 * @param sortOrders list of sort orders that must be applied
	 * @param joins      the joins to apply - if null then the default joins will be
	 *                   used
	 * @return a page of entities that match the filter
	 */
	private List&lt;T&gt; fetch(Filter filter, Pageable pageable, SortOrders sortOrders, FetchJoinInformation... joins) {
<span class="fc" id="L146">		TypedQuery&lt;T&gt; query = JpaQueryBuilder.createSelectQuery(filter, entityManager, getEntityClass(),</span>
<span class="fc bfc" id="L147" title="All 4 branches covered.">			(joins == null || joins.length == 0) ? getJoins() : joins,</span>
<span class="fc bfc" id="L148" title="All 2 branches covered.">			sortOrders == null ? null : sortOrders.toArray());</span>

<span class="fc bfc" id="L150" title="All 2 branches covered.">		if (pageable != null) {</span>
<span class="fc" id="L151">			query.setFirstResult(pageable.getOffset());</span>
<span class="fc" id="L152">			query.setMaxResults(pageable.getPageSize());</span>
		}
<span class="fc" id="L154">		return query.getResultList();</span>
	}

	protected FetchJoinInformation[] getJoins() {
<span class="fc" id="L158">		return entityModelFactory.getModel(getEntityClass())</span>
<span class="fc" id="L159">			.getFetchJoins().toArray(new FetchJoinInformation[0]);</span>
	}

	protected FetchJoinInformation[] getDetailJoins() {
<span class="fc" id="L163">		return entityModelFactory.getModel(getEntityClass())</span>
<span class="fc" id="L164">			.getDetailJoins().toArray(new FetchJoinInformation[0]);</span>
	}

	@Override
	public List&lt;T&gt; fetch(Filter filter, SortOrders sortOrders, FetchJoinInformation... joins) {
<span class="fc" id="L169">		return fetch(filter, null, sortOrders, joins);</span>
	}

	@Override
	public T fetchById(ID id, FetchJoinInformation... joins) {
<span class="fc" id="L174">		TypedQuery&lt;T&gt; query = JpaQueryBuilder.createFetchSingleObjectQuery(entityManager, getEntityClass(), id,</span>
<span class="pc bpc" id="L175" title="2 of 4 branches missed.">			(joins != null &amp;&amp; joins.length &gt; 0) ? joins : getDetailJoins());</span>
<span class="fc" id="L176">		return getFirstValue(query.getResultList());</span>
	}

	@Override
	public List&lt;T&gt; fetchByIds(List&lt;ID&gt; ids, Filter additionalFilter, SortOrders sortOrders,
							  FetchJoinInformation... joins) {
<span class="pc bpc" id="L182" title="1 of 2 branches missed.">		if (ids.isEmpty()) {</span>
<span class="nc" id="L183">			return Collections.emptyList();</span>
		}
<span class="fc" id="L185">		TypedQuery&lt;T&gt; query = JpaQueryBuilder.createFetchQuery(entityManager, getEntityClass(), ids, additionalFilter,</span>
<span class="pc bpc" id="L186" title="2 of 4 branches missed.">			sortOrders, (joins != null &amp;&amp; joins.length &gt; 0) ? joins : getJoins());</span>
<span class="fc" id="L187">		return query.getResultList();</span>
	}

	@Override
	public List&lt;T&gt; fetchByIds(List&lt;ID&gt; ids, SortOrders sortOrders, FetchJoinInformation... joins) {
<span class="fc" id="L192">		return fetchByIds(ids, null, sortOrders, joins);</span>
	}

	@Override
	public T fetchByUniqueProperty(String propertyName, Object value, boolean caseSensitive,
								   FetchJoinInformation... joins) {
<span class="fc" id="L198">		CriteriaQuery&lt;T&gt; cq = JpaQueryBuilder.createUniquePropertyFetchQuery(entityManager, getEntityClass(),</span>
<span class="pc bpc" id="L199" title="2 of 4 branches missed.">			(joins == null || joins.length == 0) ? getDetailJoins() : joins, propertyName, value, caseSensitive);</span>
<span class="fc" id="L200">		TypedQuery&lt;T&gt; query = entityManager.createQuery(cq);</span>
		try {
<span class="fc" id="L202">			return query.getSingleResult();</span>
<span class="fc" id="L203">		} catch (NoResultException ex) {</span>
<span class="fc" id="L204">			return null;</span>
<span class="nc" id="L205">		} catch (NonUniqueResultException ex) {</span>
<span class="nc" id="L206">			throw new OCSRuntimeException(&quot;Query for unique property returned multiple results&quot;, ex);</span>
		}
	}

	@Override
	public List&lt;T&gt; find(Filter filter) {
<span class="fc" id="L212">		return fetch(filter, null, null, (FetchJoinInformation[]) null);</span>
	}

	private List&lt;T&gt; find(Filter filter, Pageable pageable, SortOrders sortOrders) {
<span class="fc" id="L216">		TypedQuery&lt;T&gt; query = JpaQueryBuilder.createSelectQuery(filter, entityManager, getEntityClass(), null,</span>
<span class="pc bpc" id="L217" title="1 of 2 branches missed.">			sortOrders == null ? null : sortOrders.toArray());</span>

<span class="pc bpc" id="L219" title="1 of 2 branches missed.">		if (pageable != null) {</span>
<span class="nc" id="L220">			query.setFirstResult(pageable.getOffset());</span>
<span class="nc" id="L221">			query.setMaxResults(pageable.getPageSize());</span>
		}
<span class="fc" id="L223">		return query.getResultList();</span>
	}

	@Override
	public List&lt;T&gt; find(Filter filter, SortOrder... orders) {
<span class="fc" id="L228">		return fetch(filter, null, new SortOrders(orders), (FetchJoinInformation[]) null);</span>
	}

	@Override
	public List&lt;T&gt; findAll() {
<span class="fc" id="L233">		return findAll((SortOrder[]) null);</span>
	}

	@Override
	public List&lt;T&gt; findAll(SortOrder... sortOrders) {
<span class="fc" id="L238">		return find(null, null, new SortOrders(sortOrders));</span>
	}

	@Override
	public T findById(ID id) {
<span class="fc" id="L243">		return entityManager.find(getEntityClass(), id);</span>
	}

	@Override
	public T findByUniqueProperty(String propertyName, Object value, boolean caseSensitive) {
<span class="fc" id="L248">		CriteriaQuery&lt;T&gt; cq = JpaQueryBuilder.createUniquePropertyQuery(entityManager, getEntityClass(), propertyName,</span>
			value, caseSensitive);
<span class="fc" id="L250">		TypedQuery&lt;T&gt; query = entityManager.createQuery(cq);</span>
		try {
<span class="fc" id="L252">			return query.getSingleResult();</span>
<span class="fc" id="L253">		} catch (NoResultException ex) {</span>
<span class="fc" id="L254">			return null;</span>
<span class="nc" id="L255">		} catch (NonUniqueResultException ex) {</span>
<span class="nc" id="L256">			throw new OCSRuntimeException(&quot;Query for unique property returned multiple results&quot;, ex);</span>
		}
	}

	@Override
	@SuppressWarnings(&quot;unchecked&quot;)
	public &lt;S&gt; List&lt;S&gt; findDistinctValues(Filter filter, String distinctField, Class&lt;S&gt; elementType, SortOrder... orders) {
<span class="fc" id="L263">		TypedQuery&lt;Tuple&gt; query = JpaQueryBuilder.createDistinctQuery(filter, entityManager, getEntityClass(),</span>
			distinctField, orders);
<span class="fc" id="L265">		return query.getResultList().stream().map(t -&gt; t.get(0)).filter(Objects::nonNull).map(o -&gt; (S) o)</span>
<span class="fc" id="L266">			.toList();</span>
	}

	@Override
	@SuppressWarnings(&quot;unchecked&quot;)
	public &lt;S&gt; List&lt;S&gt; findDistinctInCollectionTable(String tableName, String distinctField, Class&lt;S&gt; elementType) {
<span class="fc" id="L272">		String query = &quot;select distinct %s from %s&quot;.formatted(distinctField, tableName);</span>
<span class="fc" id="L273">		return getEntityManager().createNativeQuery(query).getResultList();</span>
	}

	@Override
	@SuppressWarnings(&quot;unchecked&quot;)
	public List&lt;ID&gt; findIds(Filter filter, Integer maxResults, SortOrder... sortOrders) {
<span class="fc" id="L279">		TypedQuery&lt;Tuple&gt; query = JpaQueryBuilder.createIdQuery(entityManager, getEntityClass(), filter, sortOrders);</span>
<span class="pc bpc" id="L280" title="1 of 2 branches missed.">		if (maxResults != null) {</span>
<span class="nc" id="L281">			query = query.setMaxResults(maxResults);</span>
		}
<span class="fc" id="L283">		return query.getResultList().stream().map(tuple -&gt; tuple.get(0)).map(o -&gt; (ID) o).collect(Collectors.toList());</span>
	}

	@Override
	public List&lt;ID&gt; findIds(Filter filter, SortOrder... sortOrders) {
<span class="fc" id="L288">		return findIds(filter, null, sortOrders);</span>
	}

	@Override
	public void flushAndClear() {
<span class="fc" id="L293">		entityManager.flush();</span>
<span class="fc" id="L294">		entityManager.clear();</span>
<span class="fc" id="L295">	}</span>

	/**
	 * Returns the query DSL root
	 *
	 * @return the DSL root object
	 */
	protected abstract EntityPathBase&lt;T&gt; getDslRoot();

	protected EntityManager getEntityManager() {
<span class="fc" id="L305">		return entityManager;</span>
	}

//    /**
//     * Returns the fetch joins that must be included in a query to fetch the IDs.
//     * This method return an empty array by default - override when needed
//     *
//     * @return the fetch joins
//     */
//    protected FetchJoinInformation[] getFetchJoins() {
//        return new FetchJoinInformation[]{};
//    }

	/**
	 * Returns the first value of a list
	 *
	 * @param list the list
	 * @return the first value of the list, or &lt;code&gt;null&lt;/code&gt; if this does not
	 * exist
	 */
	protected T getFirstValue(List&lt;T&gt; list) {
<span class="pc bpc" id="L326" title="2 of 4 branches missed.">		return list != null &amp;&amp; !list.isEmpty() ? list.get(0) : null;</span>
	}

	/**
	 * Returns an Optional containing the first value of the provided list
	 *
	 * @param list the list to select the first value from
	 * @return the Optional
	 */
	protected Optional&lt;T&gt; getFirstValueOptional(List&lt;T&gt; list) {
<span class="nc" id="L336">		return Optional.ofNullable(getFirstValue(list));</span>
	}

	@Override
	public List&lt;T&gt; save(List&lt;T&gt; list) {
<span class="fc" id="L341">		List&lt;T&gt; result = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L342" title="All 2 branches covered.">		for (T entity : list) {</span>
<span class="fc" id="L343">			result.add(this.save(entity));</span>
<span class="fc" id="L344">		}</span>
<span class="fc" id="L345">		return result;</span>
	}

	@Override
	public T save(T entity) {
<span class="fc bfc" id="L350" title="All 2 branches covered.">		if (entity.getId() == null) {</span>
<span class="fc" id="L351">			entityManager.persist(entity);</span>
		} else {
<span class="fc" id="L353">			entity = entityManager.merge(entity);</span>
		}
<span class="fc" id="L355">		return entity;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>