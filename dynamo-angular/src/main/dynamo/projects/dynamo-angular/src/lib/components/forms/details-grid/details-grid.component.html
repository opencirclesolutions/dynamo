<!--
#%L
Dynamo Framework
%%
Copyright (C) 2014 - 2024 Open Circle Solutions
%%
Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
#L%
-->
@if (entityModel) {
  <div
    class="edit-table row"
    >
    <p-table
      [value]="getRows()"
      [lazy]="false"
      [rows]="pageSize"
      styleClass="p-datatable-sm"
      [paginator]="am!.showDetailsPaginator"
      [totalRecords]="getTotalRecords()"
      [showCurrentPageReport]="false"
      currentPageReportTemplate="Show {first} to {last} of {totalRecords} items"
      [rowsPerPageOptions]="[10, 25, 50]"> @if (entityModel) {
      <ng-template
        pTemplate="header"
        >
        <tr>
          @for (am of this.attributeModels; track am) {
            <th
              scope="am"
              [ngStyle]=""
              [pSortableColumnDisabled]="true"
              [pSortableColumn]="''"><ng-container> {{ am.displayNames[locale] }} {{ am.required ? "*" : "" }}
            </ng-container></th>
          }
          <th>
            <p-button
              type="button"
              icon="pi pi-plus"
              pTooltip=" {{ 'add' | translate }}"
              (click)="addButtonClick()"/>
          </th>
        </tr>
      </ng-template>
      } <ng-template
      pTemplate="body"
      let-row
      let-rowIndex="rowIndex">
      @if (getFormGroup(rowIndex)) {
        <tr
          [formGroup]="getFormGroup(rowIndex)"
          >
          @for (am of attributeModels; track am) {
            <td>@if (!isEditable(row, am)) {
              <div class="row p-2">
                <div class="col-10">
                  <d-field-view
                    [am]="am"
                    [entity]="row"
                    [locale]="locale">
                  </d-field-view>
                </div>
              </div>
              } @if (isEditable(row, am)) {
              <!-- String field -->
              @if (isString(am)) {
                <div>
                  @if (getFormControl(am, rowIndex)) {
                    <d-string-field
                      [am]="am"
                      [formGroup]="getFormGroup(rowIndex)"
                      [formControl]="getFormControl(am, rowIndex)"
                      [allowTextAreas]="false"
                    ngDefaultControl> </d-string-field>
                  }
                </div>
              }
              @if (isEnum(am)) {
                <div>
                  @if (getFormControl(am, rowIndex)) {
                    <d-enum-field
                      [am]="am"
                      [formGroup]="getFormGroup(rowIndex)"
                      [formControl]="getFormControl(am, rowIndex)"
                      [options]="getEnumValues(am.name)"
                    ngDefaultControl></d-enum-field>
                  }
                </div>
              }
              @if (isDate(am)) {
                <div>
                  @if (getFormControl(am, rowIndex)) {
                    <d-date-field
                      [am]="am"
                      [formGroup]="getFormGroup(rowIndex)"
                      [formControl]="getFormControl(am, rowIndex)"
                    ngDefaultControl></d-date-field>
                  }
                </div>
              }
              @if (isTime(am)) {
                <div>
                  @if (getFormControl(am, rowIndex)) {
                    <d-time-field
                      [am]="am"
                      [formGroup]="getFormGroup(rowIndex)"
                      [formControl]="getFormControl(am, rowIndex)"
                    ngDefaultControl></d-time-field>
                  }
                </div>
              }
              @if (isInstant(am) || isLocalDateTime(am)) {
                <div>
                  @if (getFormControl(am, rowIndex)) {
                    <d-timestamp-field
                      [am]="am"
                      [locale]="locale"
                      [formGroup]="getFormGroup(rowIndex)"
                      [formControl]="getFormControl(am, rowIndex)"
                    ngDefaultControl> </d-timestamp-field>
                  }
                </div>
              }
              @if (isMaster(am) && getNestedEntityModel(am)) {
                <div>
                  @if (getFormControl(am, rowIndex)) {
                    <d-select-entity-field
                      [am]="am"
                      [options]="lookupEntities(am.lookupEntityName!)"
                      [formGroup]="getFormGroup(rowIndex)"
                      [formControl]="getFormControl(am, rowIndex)"
                      [nested]="true"
                      [entityModel]="getNestedEntityModel(am)"
                    ngDefaultControl> </d-select-entity-field>
                  }
                </div>
              }
              @if (isBoolean(am)) {
                <div>
                  @if (getFormControl(am, rowIndex)) {
                    <p-checkbox
                      [id]="am.name"
                      [name]="am.name"
                      [formControl]="getFormControl(am, rowIndex)"
                      [binary]="true"
                    > </p-checkbox>
                  }
                </div>
              }
              @if (isIntegral(am)) {
                <div>
                  @if (getFormControl(am, rowIndex)) {
                    <d-number-field
                      [am]="am"
                      [formGroup]="getFormGroup(rowIndex)"
                      [formControl]="getFormControl(am, rowIndex)"
                      [locale]="locale"
                    ngDefaultControl> </d-number-field>
                  }
                </div>
              }
              @if (isDecimal(am)) {
                <div>
                  @if (getFormControl(am, rowIndex)) {
                    <d-decimal-field
                      [am]="am"
                      [formGroup]="getFormGroup(rowIndex)"
                      [formControl]="getFormControl(am, rowIndex)"
                      [locale]="locale"
                    ngDefaultControl> </d-decimal-field>
                  }
                </div>
              }
            }</td>
          }
          <td>
            <p-button
              type="button"
              severity="danger"
              icon="pi pi-trash"
              pTooltip=" {{ 'add' | translate}}"
              (click)="deleteRow(rowIndex)"/>
          </td>
        </tr>
      }
      <ng-container
		[ngTemplateOutlet]="
          customValidatorTemplate || defaultCustomValidatorTemplate
        "
      [ngTemplateOutletContext]="{ $implicit: getFormGroup(rowIndex) }"> </ng-container> </ng-template> </p-table>
      <ng-template #defaultCustomValidatorTemplate> </ng-template>
    </div>
  }
